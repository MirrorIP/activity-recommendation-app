var Base64=(function(){var a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";var b={encode:function(e){var c="";var m,k,h;var l,j,g,f;var d=0;do{m=e.charCodeAt(d++);k=e.charCodeAt(d++);h=e.charCodeAt(d++);l=m>>2;j=((m&3)<<4)|(k>>4);g=((k&15)<<2)|(h>>6);f=h&63;if(isNaN(k)){g=f=64;}else{if(isNaN(h)){f=64;}}c=c+a.charAt(l)+a.charAt(j)+a.charAt(g)+a.charAt(f);}while(d<e.length);return c;},decode:function(e){var c="";var m,k,h;var l,j,g,f;var d=0;e=e.replace(/[^A-Za-z0-9\+\/\=]/g,"");do{l=a.indexOf(e.charAt(d++));j=a.indexOf(e.charAt(d++));g=a.indexOf(e.charAt(d++));f=a.indexOf(e.charAt(d++));m=(l<<2)|(j>>4);k=((j&15)<<4)|(g>>2);h=((g&3)<<6)|f;c=c+String.fromCharCode(m);if(g!=64){c=c+String.fromCharCode(k);}if(f!=64){c=c+String.fromCharCode(h);}}while(d<e.length);return c;}};return b;})();function b64_sha1(a){return binb2b64(core_sha1(str2binb(a),a.length*8));}function str_sha1(a){return binb2str(core_sha1(str2binb(a),a.length*8));}function b64_hmac_sha1(a,b){return binb2b64(core_hmac_sha1(a,b));}function str_hmac_sha1(a,b){return binb2str(core_hmac_sha1(a,b));}function core_sha1(v,o){v[o>>5]|=128<<(24-o%32);v[((o+64>>9)<<4)+15]=o;var y=new Array(80);var u=1732584193;var s=-271733879;var r=-1732584194;var q=271733878;var p=-1009589776;var l,h,z,n,m,k,g,f;for(l=0;l<v.length;l+=16){n=u;m=s;k=r;g=q;f=p;for(h=0;h<80;h++){if(h<16){y[h]=v[l+h];}else{y[h]=rol(y[h-3]^y[h-8]^y[h-14]^y[h-16],1);}z=safe_add(safe_add(rol(u,5),sha1_ft(h,s,r,q)),safe_add(safe_add(p,y[h]),sha1_kt(h)));p=q;q=r;r=rol(s,30);s=u;u=z;}u=safe_add(u,n);s=safe_add(s,m);r=safe_add(r,k);q=safe_add(q,g);p=safe_add(p,f);}return[u,s,r,q,p];}function sha1_ft(e,a,g,f){if(e<20){return(a&g)|((~a)&f);}if(e<40){return a^g^f;}if(e<60){return(a&g)|(a&f)|(g&f);}return a^g^f;}function sha1_kt(a){return(a<20)?1518500249:(a<40)?1859775393:(a<60)?-1894007588:-899497514;}function core_hmac_sha1(c,f){var e=str2binb(c);if(e.length>16){e=core_sha1(e,c.length*8);}var a=new Array(16),d=new Array(16);for(var b=0;b<16;b++){a[b]=e[b]^909522486;d[b]=e[b]^1549556828;}var g=core_sha1(a.concat(str2binb(f)),512+f.length*8);return core_sha1(d.concat(g),512+160);}function safe_add(a,d){var c=(a&65535)+(d&65535);var b=(a>>16)+(d>>16)+(c>>16);return(b<<16)|(c&65535);}function rol(a,b){return(a<<b)|(a>>>(32-b));}function str2binb(d){var c=[];var a=255;for(var b=0;b<d.length*8;b+=8){c[b>>5]|=(d.charCodeAt(b/8)&a)<<(24-b%32);}return c;}function binb2str(c){var d="";var a=255;for(var b=0;b<c.length*32;b+=8){d+=String.fromCharCode((c[b>>5]>>>(24-b%32))&a);}return d;}function binb2b64(d){var c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";var f="";var e,a;for(var b=0;b<d.length*4;b+=3){e=(((d[b>>2]>>8*(3-b%4))&255)<<16)|(((d[b+1>>2]>>8*(3-(b+1)%4))&255)<<8)|((d[b+2>>2]>>8*(3-(b+2)%4))&255);for(a=0;a<4;a++){if(b*8+a*6>d.length*32){f+="=";}else{f+=c.charAt((e>>6*(3-a))&63);}}}return f;}var MD5=(function(){var h=function(m,p){var o=(m&65535)+(p&65535);var n=(m>>16)+(p>>16)+(o>>16);return(n<<16)|(o&65535);};var k=function(m,n){return(m<<n)|(m>>>(32-n));};var a=function(o){var n=[];for(var m=0;m<o.length*8;m+=8){n[m>>5]|=(o.charCodeAt(m/8)&255)<<(m%32);}return n;};var e=function(n){var o="";for(var m=0;m<n.length*32;m+=8){o+=String.fromCharCode((n[m>>5]>>>(m%32))&255);}return o;};var l=function(o){var n="0123456789abcdef";var p="";for(var m=0;m<o.length*4;m++){p+=n.charAt((o[m>>2]>>((m%4)*8+4))&15)+n.charAt((o[m>>2]>>((m%4)*8))&15);}return p;};var b=function(u,o,n,m,r,p){return h(k(h(h(o,u),h(m,p)),r),n);};var i=function(o,n,u,r,m,q,p){return b((n&u)|((~n)&r),o,n,m,q,p);};var c=function(o,n,u,r,m,q,p){return b((n&r)|(u&(~r)),o,n,m,q,p);};var j=function(o,n,u,r,m,q,p){return b(n^u^r,o,n,m,q,p);};var g=function(o,n,u,r,m,q,p){return b(u^(n|(~r)),o,n,m,q,p);};var d=function(w,r){w[r>>5]|=128<<((r)%32);w[(((r+64)>>>9)<<4)+14]=r;var v=1732584193;var u=-271733879;var t=-1732584194;var s=271733878;var q,p,o,m;for(var n=0;n<w.length;n+=16){q=v;p=u;o=t;m=s;v=i(v,u,t,s,w[n+0],7,-680876936);s=i(s,v,u,t,w[n+1],12,-389564586);t=i(t,s,v,u,w[n+2],17,606105819);u=i(u,t,s,v,w[n+3],22,-1044525330);v=i(v,u,t,s,w[n+4],7,-176418897);s=i(s,v,u,t,w[n+5],12,1200080426);t=i(t,s,v,u,w[n+6],17,-1473231341);u=i(u,t,s,v,w[n+7],22,-45705983);v=i(v,u,t,s,w[n+8],7,1770035416);s=i(s,v,u,t,w[n+9],12,-1958414417);t=i(t,s,v,u,w[n+10],17,-42063);u=i(u,t,s,v,w[n+11],22,-1990404162);v=i(v,u,t,s,w[n+12],7,1804603682);s=i(s,v,u,t,w[n+13],12,-40341101);t=i(t,s,v,u,w[n+14],17,-1502002290);u=i(u,t,s,v,w[n+15],22,1236535329);v=c(v,u,t,s,w[n+1],5,-165796510);s=c(s,v,u,t,w[n+6],9,-1069501632);t=c(t,s,v,u,w[n+11],14,643717713);u=c(u,t,s,v,w[n+0],20,-373897302);v=c(v,u,t,s,w[n+5],5,-701558691);s=c(s,v,u,t,w[n+10],9,38016083);t=c(t,s,v,u,w[n+15],14,-660478335);u=c(u,t,s,v,w[n+4],20,-405537848);v=c(v,u,t,s,w[n+9],5,568446438);s=c(s,v,u,t,w[n+14],9,-1019803690);t=c(t,s,v,u,w[n+3],14,-187363961);u=c(u,t,s,v,w[n+8],20,1163531501);v=c(v,u,t,s,w[n+13],5,-1444681467);s=c(s,v,u,t,w[n+2],9,-51403784);t=c(t,s,v,u,w[n+7],14,1735328473);u=c(u,t,s,v,w[n+12],20,-1926607734);v=j(v,u,t,s,w[n+5],4,-378558);s=j(s,v,u,t,w[n+8],11,-2022574463);t=j(t,s,v,u,w[n+11],16,1839030562);u=j(u,t,s,v,w[n+14],23,-35309556);v=j(v,u,t,s,w[n+1],4,-1530992060);s=j(s,v,u,t,w[n+4],11,1272893353);t=j(t,s,v,u,w[n+7],16,-155497632);u=j(u,t,s,v,w[n+10],23,-1094730640);v=j(v,u,t,s,w[n+13],4,681279174);s=j(s,v,u,t,w[n+0],11,-358537222);t=j(t,s,v,u,w[n+3],16,-722521979);u=j(u,t,s,v,w[n+6],23,76029189);v=j(v,u,t,s,w[n+9],4,-640364487);s=j(s,v,u,t,w[n+12],11,-421815835);t=j(t,s,v,u,w[n+15],16,530742520);u=j(u,t,s,v,w[n+2],23,-995338651);v=g(v,u,t,s,w[n+0],6,-198630844);s=g(s,v,u,t,w[n+7],10,1126891415);t=g(t,s,v,u,w[n+14],15,-1416354905);u=g(u,t,s,v,w[n+5],21,-57434055);v=g(v,u,t,s,w[n+12],6,1700485571);s=g(s,v,u,t,w[n+3],10,-1894986606);t=g(t,s,v,u,w[n+10],15,-1051523);u=g(u,t,s,v,w[n+1],21,-2054922799);v=g(v,u,t,s,w[n+8],6,1873313359);s=g(s,v,u,t,w[n+15],10,-30611744);t=g(t,s,v,u,w[n+6],15,-1560198380);u=g(u,t,s,v,w[n+13],21,1309151649);v=g(v,u,t,s,w[n+4],6,-145523070);s=g(s,v,u,t,w[n+11],10,-1120210379);t=g(t,s,v,u,w[n+2],15,718787259);u=g(u,t,s,v,w[n+9],21,-343485551);v=h(v,q);u=h(u,p);t=h(t,o);s=h(s,m);}return[v,u,t,s];};var f={hexdigest:function(m){return l(d(a(m),m.length*8));},hash:function(m){return e(d(a(m),m.length*8));}};return f;})();if(!Function.prototype.bind){Function.prototype.bind=function(e){var d=this;var c=Array.prototype.slice;var b=Array.prototype.concat;var a=c.call(arguments,1);return function(){return d.apply(e?e:this,b.call(a,c.call(arguments,0)));};};}if(!Array.prototype.indexOf){Array.prototype.indexOf=function(b){var a=this.length;var c=Number(arguments[1])||0;c=(c<0)?Math.ceil(c):Math.floor(c);if(c<0){c+=a;}for(;c<a;c++){if(c in this&&this[c]===b){return c;}}return -1;};}(function(f){var e;function c(h,g){return new e.Builder(h,g);}function a(g){return new e.Builder("message",g);}function d(g){return new e.Builder("iq",g);}function b(g){return new e.Builder("presence",g);}e={VERSION:"1.1.3",NS:{HTTPBIND:"http://jabber.org/protocol/httpbind",BOSH:"urn:xmpp:xbosh",CLIENT:"jabber:client",AUTH:"jabber:iq:auth",ROSTER:"jabber:iq:roster",PROFILE:"jabber:iq:profile",DISCO_INFO:"http://jabber.org/protocol/disco#info",DISCO_ITEMS:"http://jabber.org/protocol/disco#items",MUC:"http://jabber.org/protocol/muc",SASL:"urn:ietf:params:xml:ns:xmpp-sasl",STREAM:"http://etherx.jabber.org/streams",BIND:"urn:ietf:params:xml:ns:xmpp-bind",SESSION:"urn:ietf:params:xml:ns:xmpp-session",VERSION:"jabber:iq:version",STANZAS:"urn:ietf:params:xml:ns:xmpp-stanzas",XHTML_IM:"http://jabber.org/protocol/xhtml-im",XHTML:"http://www.w3.org/1999/xhtml"},XHTML:{tags:["a","blockquote","br","cite","em","img","li","ol","p","span","strong","ul","body"],attributes:{a:["href"],blockquote:["style"],br:[],cite:["style"],em:[],img:["src","alt","style","height","width"],li:["style"],ol:["style"],p:["style"],span:["style"],strong:[],ul:["style"],body:[]},css:["background-color","color","font-family","font-size","font-style","font-weight","margin-left","margin-right","text-align","text-decoration"],validTag:function(g){for(var h=0;h<e.XHTML.tags.length;h++){if(g==e.XHTML.tags[h]){return true;}}return false;},validAttribute:function(g,j){if(typeof e.XHTML.attributes[g]!=="undefined"&&e.XHTML.attributes[g].length>0){for(var h=0;h<e.XHTML.attributes[g].length;h++){if(j==e.XHTML.attributes[g][h]){return true;}}}return false;},validCSS:function(h){for(var g=0;g<e.XHTML.css.length;g++){if(h==e.XHTML.css[g]){return true;}}return false;}},Status:{ERROR:0,CONNECTING:1,CONNFAIL:2,AUTHENTICATING:3,AUTHFAIL:4,CONNECTED:5,DISCONNECTED:6,DISCONNECTING:7,ATTACHED:8},LogLevel:{DEBUG:0,INFO:1,WARN:2,ERROR:3,FATAL:4},ElementType:{NORMAL:1,TEXT:3,CDATA:4,FRAGMENT:11},TIMEOUT:1.1,SECONDARY_TIMEOUT:0.1,addNamespace:function(g,h){e.NS[g]=h;},forEachChild:function(k,l,j){var h,g;for(h=0;h<k.childNodes.length;h++){g=k.childNodes[h];if(g.nodeType==e.ElementType.NORMAL&&(!l||this.isTagEqual(g,l))){j(g);}}},isTagEqual:function(h,g){return h.tagName.toLowerCase()==g.toLowerCase();},_xmlGenerator:null,_makeGenerator:function(){var g;if(document.implementation.createDocument===undefined||document.implementation.createDocument&&document.documentMode&&document.documentMode<10){g=this._getIEXmlDom();g.appendChild(g.createElement("strophe"));}else{g=document.implementation.createDocument("jabber:client","strophe",null);}return g;},xmlGenerator:function(){if(!e._xmlGenerator){e._xmlGenerator=e._makeGenerator();}return e._xmlGenerator;},_getIEXmlDom:function(){var h=null;var j=["Msxml2.DOMDocument.6.0","Msxml2.DOMDocument.5.0","Msxml2.DOMDocument.4.0","MSXML2.DOMDocument.3.0","MSXML2.DOMDocument","MSXML.DOMDocument","Microsoft.XMLDOM"];for(var i=0;i<j.length;i++){if(h===null){try{h=new ActiveXObject(j[i]);}catch(g){h=null;}}else{break;}}return h;},xmlElement:function(j){if(!j){return null;}var m=e.xmlGenerator().createElement(j);var g,l,h;for(g=1;g<arguments.length;g++){if(!arguments[g]){continue;}if(typeof(arguments[g])=="string"||typeof(arguments[g])=="number"){m.appendChild(e.xmlTextNode(arguments[g]));}else{if(typeof(arguments[g])=="object"&&typeof(arguments[g].sort)=="function"){for(l=0;l<arguments[g].length;l++){if(typeof(arguments[g][l])=="object"&&typeof(arguments[g][l].sort)=="function"){m.setAttribute(arguments[g][l][0],arguments[g][l][1]);}}}else{if(typeof(arguments[g])=="object"){for(h in arguments[g]){if(arguments[g].hasOwnProperty(h)){m.setAttribute(h,arguments[g][h]);}}}}}}return m;},xmlescape:function(g){g=g.replace(/\&/g,"&amp;");g=g.replace(/</g,"&lt;");g=g.replace(/>/g,"&gt;");g=g.replace(/'/g,"&apos;");g=g.replace(/"/g,"&quot;");return g;},xmlTextNode:function(g){return e.xmlGenerator().createTextNode(g);},xmlHtmlNode:function(g){var h;if(window.DOMParser){var i=new DOMParser();h=i.parseFromString(g,"text/xml");}else{h=new ActiveXObject("Microsoft.XMLDOM");h.async="false";h.loadXML(g);}return h;},getText:function(h){if(!h){return null;}var j="";if(h.childNodes.length===0&&h.nodeType==e.ElementType.TEXT){j+=h.nodeValue;}for(var g=0;g<h.childNodes.length;g++){if(h.childNodes[g].nodeType==e.ElementType.TEXT){j+=h.childNodes[g].nodeValue;}}return e.xmlescape(j);},copyElement:function(j){var g,h;if(j.nodeType==e.ElementType.NORMAL){h=e.xmlElement(j.tagName);for(g=0;g<j.attributes.length;g++){h.setAttribute(j.attributes[g].nodeName,j.attributes[g].value);}for(g=0;g<j.childNodes.length;g++){h.appendChild(e.copyElement(j.childNodes[g]));}}else{if(j.nodeType==e.ElementType.TEXT){h=e.xmlGenerator().createTextNode(j.nodeValue);}}return h;},createHtml:function(k){var n,h,l,u,g,t,p,q,s,m,o;if(k.nodeType==e.ElementType.NORMAL){u=k.nodeName.toLowerCase();if(e.XHTML.validTag(u)){try{h=e.xmlElement(u);for(n=0;n<e.XHTML.attributes[u].length;n++){g=e.XHTML.attributes[u][n];t=k.getAttribute(g);if(typeof t=="undefined"||t===null||t===""||t===false||t===0){continue;}if(g=="style"&&typeof t=="object"){if(typeof t.cssText!="undefined"){t=t.cssText;}}if(g=="style"){p=[];q=t.split(";");for(l=0;l<q.length;l++){s=q[l].split(":");m=s[0].replace(/^\s*/,"").replace(/\s*$/,"").toLowerCase();if(e.XHTML.validCSS(m)){o=s[1].replace(/^\s*/,"").replace(/\s*$/,"");p.push(m+": "+o);}}if(p.length>0){t=p.join("; ");h.setAttribute(g,t);}}else{h.setAttribute(g,t);}}for(n=0;n<k.childNodes.length;n++){h.appendChild(e.createHtml(k.childNodes[n]));}}catch(r){h=e.xmlTextNode("");}}else{h=e.xmlGenerator().createDocumentFragment();for(n=0;n<k.childNodes.length;n++){h.appendChild(e.createHtml(k.childNodes[n]));}}}else{if(k.nodeType==e.ElementType.FRAGMENT){h=e.xmlGenerator().createDocumentFragment();for(n=0;n<k.childNodes.length;n++){h.appendChild(e.createHtml(k.childNodes[n]));}}else{if(k.nodeType==e.ElementType.TEXT){h=e.xmlTextNode(k.nodeValue);}}}return h;},escapeNode:function(g){return g.replace(/^\s+|\s+$/g,"").replace(/\\/g,"\\5c").replace(/ /g,"\\20").replace(/\"/g,"\\22").replace(/\&/g,"\\26").replace(/\'/g,"\\27").replace(/\//g,"\\2f").replace(/:/g,"\\3a").replace(/</g,"\\3c").replace(/>/g,"\\3e").replace(/@/g,"\\40");},unescapeNode:function(g){return g.replace(/\\20/g," ").replace(/\\22/g,'"').replace(/\\26/g,"&").replace(/\\27/g,"'").replace(/\\2f/g,"/").replace(/\\3a/g,":").replace(/\\3c/g,"<").replace(/\\3e/g,">").replace(/\\40/g,"@").replace(/\\5c/g,"\\");},getNodeFromJid:function(g){if(g.indexOf("@")<0){return null;}return g.split("@")[0];},getDomainFromJid:function(g){var h=e.getBareJidFromJid(g);if(h.indexOf("@")<0){return h;}else{var i=h.split("@");i.splice(0,1);return i.join("@");}},getResourceFromJid:function(g){var h=g.split("/");if(h.length<2){return null;}h.splice(0,1);return h.join("/");},getBareJidFromJid:function(g){return g?g.split("/")[0]:null;},log:function(h,g){return;},debug:function(g){this.log(this.LogLevel.DEBUG,g);},info:function(g){this.log(this.LogLevel.INFO,g);},warn:function(g){this.log(this.LogLevel.WARN,g);},error:function(g){this.log(this.LogLevel.ERROR,g);},fatal:function(g){this.log(this.LogLevel.FATAL,g);},serialize:function(j){var g;if(!j){return null;}if(typeof(j.tree)==="function"){j=j.tree();}var l=j.nodeName;var h,k;if(j.getAttribute("_realname")){l=j.getAttribute("_realname");}g="<"+l;for(h=0;h<j.attributes.length;h++){if(j.attributes[h].nodeName!="_realname"){g+=" "+j.attributes[h].nodeName+"='"+j.attributes[h].value.replace(/&/g,"&amp;").replace(/\'/g,"&apos;").replace(/>/g,"&gt;").replace(/</g,"&lt;")+"'";}}if(j.childNodes.length>0){g+=">";for(h=0;h<j.childNodes.length;h++){k=j.childNodes[h];switch(k.nodeType){case e.ElementType.NORMAL:g+=e.serialize(k);break;case e.ElementType.TEXT:g+=e.xmlescape(k.nodeValue);break;case e.ElementType.CDATA:g+="<![CDATA["+k.nodeValue+"]]>";}}g+="</"+l+">";}else{g+="/>";}return g;},_requestId:0,_connectionPlugins:{},addConnectionPlugin:function(g,h){e._connectionPlugins[g]=h;}};e.Builder=function(h,g){if(h=="presence"||h=="message"||h=="iq"){if(g&&!g.xmlns){g.xmlns=e.NS.CLIENT;}else{if(!g){g={xmlns:e.NS.CLIENT};}}}this.nodeTree=e.xmlElement(h,g);this.node=this.nodeTree;};e.Builder.prototype={tree:function(){return this.nodeTree;},toString:function(){return e.serialize(this.nodeTree);},up:function(){this.node=this.node.parentNode;return this;},attrs:function(h){for(var g in h){if(h.hasOwnProperty(g)){this.node.setAttribute(g,h[g]);}}return this;},c:function(h,g,i){var j=e.xmlElement(h,g,i);this.node.appendChild(j);if(!i){this.node=j;}return this;},cnode:function(i){var h;var k=e.xmlGenerator();try{h=(k.importNode!==undefined);}catch(j){h=false;}var g=h?k.importNode(i,true):e.copyElement(i);this.node.appendChild(g);this.node=g;return this;},t:function(g){var h=e.xmlTextNode(g);this.node.appendChild(h);return this;},h:function(h){var g=document.createElement("body");g.innerHTML=h;var i=e.createHtml(g);while(i.childNodes.length>0){this.node.appendChild(i.childNodes[0]);}return this;}};e.Handler=function(k,j,h,i,m,l,g){this.handler=k;this.ns=j;this.name=h;this.type=i;this.id=m;this.options=g||{matchBare:false};if(!this.options.matchBare){this.options.matchBare=false;}if(this.options.matchBare){this.from=l?e.getBareJidFromJid(l):null;}else{this.from=l;}this.user=true;};e.Handler.prototype={isMatch:function(h){var j;var i=null;if(this.options.matchBare){i=e.getBareJidFromJid(h.getAttribute("from"));}else{i=h.getAttribute("from");}j=false;if(!this.ns){j=true;}else{var g=this;e.forEachChild(h,null,function(k){if(k.getAttribute("xmlns")==g.ns){j=true;}});j=j||h.getAttribute("xmlns")==this.ns;}if(j&&(!this.name||e.isTagEqual(h,this.name))&&(!this.type||h.getAttribute("type")==this.type)&&(!this.id||h.getAttribute("id")==this.id)&&(!this.from||i==this.from)){return true;}return false;},run:function(h){var g=null;try{g=this.handler(h);}catch(i){if(i.sourceURL){e.fatal("error: "+this.handler+" "+i.sourceURL+":"+i.line+" - "+i.name+": "+i.message);}else{if(i.fileName){if(typeof(console)!="undefined"){console.trace();console.error(this.handler," - error - ",i,i.message);}e.fatal("error: "+this.handler+" "+i.fileName+":"+i.lineNumber+" - "+i.name+": "+i.message);}else{e.fatal("error: "+i.message+"\n"+i.stack);}}throw i;}return g;},toString:function(){return"{Handler: "+this.handler+"("+this.name+","+this.id+","+this.ns+")}";}};e.TimedHandler=function(h,g){this.period=h;this.handler=g;this.lastCalled=new Date().getTime();this.user=true;};e.TimedHandler.prototype={run:function(){this.lastCalled=new Date().getTime();return this.handler();},reset:function(){this.lastCalled=new Date().getTime();},toString:function(){return"{TimedHandler: "+this.handler+"("+this.period+")}";}};e.Connection=function(g,i){this.service=g;this.options=i||{};var m=this.options.protocol||"";if(g.indexOf("ws:")===0||g.indexOf("wss:")===0||m.indexOf("ws")===0){this._proto=new e.Websocket(this);}else{this._proto=new e.Bosh(this);}this.jid="";this.domain=null;this.features=null;this._sasl_data={};this.do_session=false;this.do_bind=false;this.timedHandlers=[];this.handlers=[];this.removeTimeds=[];this.removeHandlers=[];this.addTimeds=[];this.addHandlers=[];this._authentication={};this._idleTimeout=null;this._disconnectTimeout=null;this.do_authentication=true;this.authenticated=false;this.disconnecting=false;this.connected=false;this.errors=0;this.paused=false;this._data=[];this._uniqueId=0;this._sasl_success_handler=null;this._sasl_failure_handler=null;this._sasl_challenge_handler=null;this.maxRetries=5;this._idleTimeout=setTimeout(this._onIdle.bind(this),100);for(var h in e._connectionPlugins){if(e._connectionPlugins.hasOwnProperty(h)){var l=e._connectionPlugins[h];var j=function(){};j.prototype=l;this[h]=new j();this[h].init(this);}}};e.Connection.prototype={reset:function(){this._proto._reset();this.do_session=false;this.do_bind=false;this.timedHandlers=[];this.handlers=[];this.removeTimeds=[];this.removeHandlers=[];this.addTimeds=[];this.addHandlers=[];this._authentication={};this.authenticated=false;this.disconnecting=false;this.connected=false;this.errors=0;this._requests=[];this._uniqueId=0;},pause:function(){this.paused=true;},resume:function(){this.paused=false;},getUniqueId:function(g){if(typeof(g)=="string"||typeof(g)=="number"){return ++this._uniqueId+":"+g;}else{return ++this._uniqueId+"";}},connect:function(h,i,l,k,j,g){this.jid=h;this.authzid=e.getBareJidFromJid(this.jid);this.authcid=e.getNodeFromJid(this.jid);this.pass=i;this.servtype="xmpp";this.connect_callback=l;this.disconnecting=false;this.connected=false;this.authenticated=false;this.errors=0;this.domain=e.getDomainFromJid(this.jid);this._changeConnectStatus(e.Status.CONNECTING,null);this._proto._connect(k,j,g);},attach:function(i,g,j,m,l,k,h){this._proto._attach(i,g,j,m,l,k,h);},xmlInput:function(g){return;},xmlOutput:function(g){return;},rawInput:function(g){return;},rawOutput:function(g){return;},send:function(h){if(h===null){return;}if(typeof(h.sort)==="function"){for(var g=0;g<h.length;g++){this._queueData(h[g]);}}else{if(typeof(h.tree)==="function"){this._queueData(h.tree());}else{this._queueData(h);}}this._proto._send();},flush:function(){clearTimeout(this._idleTimeout);this._onIdle();},sendIQ:function(j,n,g,k){var l=null;var i=this;if(typeof(j.tree)==="function"){j=j.tree();}var m=j.getAttribute("id");if(!m){m=this.getUniqueId("sendIQ");j.setAttribute("id",m);}var h=this.addHandler(function(p){if(l){i.deleteTimedHandler(l);}var o=p.getAttribute("type");if(o=="result"){if(n){n(p);}}else{if(o=="error"){if(g){g(p);}}else{throw {name:"StropheError",message:"Got bad IQ type of "+o};}}},null,"iq",null,m);if(k){l=this.addTimedHandler(k,function(){i.deleteHandler(h);if(g){g(null);}return false;});}this.send(j);return m;},_queueData:function(g){if(g===null||!g.tagName||!g.childNodes){throw {name:"StropheError",message:"Cannot queue non-DOMElement."};}this._data.push(g);},_sendRestart:function(){this._data.push("restart");this._proto._sendRestart();this._idleTimeout=setTimeout(this._onIdle.bind(this),100);},addTimedHandler:function(i,h){var g=new e.TimedHandler(i,h);this.addTimeds.push(g);return g;},deleteTimedHandler:function(g){this.removeTimeds.push(g);},addHandler:function(l,k,i,j,n,m,h){var g=new e.Handler(l,k,i,j,n,m,h);this.addHandlers.push(g);return g;},deleteHandler:function(g){this.removeHandlers.push(g);},disconnect:function(g){this._changeConnectStatus(e.Status.DISCONNECTING,g);e.info("Disconnect was called because: "+g);if(this.connected){var h=false;this.disconnecting=true;if(this.authenticated){h=b({xmlns:e.NS.CLIENT,type:"unavailable"});}this._disconnectTimeout=this._addSysTimedHandler(3000,this._onDisconnectTimeout.bind(this));this._proto._disconnect(h);}},_changeConnectStatus:function(g,m){for(var h in e._connectionPlugins){if(e._connectionPlugins.hasOwnProperty(h)){var j=this[h];if(j.statusChanged){try{j.statusChanged(g,m);}catch(i){e.error(""+h+" plugin caused an exception changing status: "+i);}}}}if(this.connect_callback){try{this.connect_callback(g,m);}catch(l){e.error("User connection callback caused an exception: "+l);}}},_doDisconnect:function(){if(this._disconnectTimeout!==null){this.deleteTimedHandler(this._disconnectTimeout);this._disconnectTimeout=null;}e.info("_doDisconnect was called");this._proto._doDisconnect();this.authenticated=false;this.disconnecting=false;this.handlers=[];this.timedHandlers=[];this.removeTimeds=[];this.removeHandlers=[];this.addTimeds=[];this.addHandlers=[];this._changeConnectStatus(e.Status.DISCONNECTED,null);this.connected=false;},_dataRecv:function(o,p){e.info("_dataRecv called");var g=this._proto._reqToData(o);if(g===null){return;}if(this.xmlInput!==e.Connection.prototype.xmlInput){if(g.nodeName===this._proto.strip&&g.childNodes.length){this.xmlInput(g.childNodes[0]);}else{this.xmlInput(g);}}if(this.rawInput!==e.Connection.prototype.rawInput){if(p){this.rawInput(p);}else{this.rawInput(e.serialize(g));}}var l,j;while(this.removeHandlers.length>0){j=this.removeHandlers.pop();l=this.handlers.indexOf(j);if(l>=0){this.handlers.splice(l,1);}}while(this.addHandlers.length>0){this.handlers.push(this.addHandlers.pop());}if(this.disconnecting&&this._proto._emptyQueue()){this._doDisconnect();return;}var h=g.getAttribute("type");var n,k;if(h!==null&&h=="terminate"){if(this.disconnecting){return;}n=g.getAttribute("condition");k=g.getElementsByTagName("conflict");if(n!==null){if(n=="remote-stream-error"&&k.length>0){n="conflict";}this._changeConnectStatus(e.Status.CONNFAIL,n);}else{this._changeConnectStatus(e.Status.CONNFAIL,"unknown");}this.disconnect("unknown stream-error");return;}var m=this;e.forEachChild(g,null,function(u){var r,s;s=m.handlers;m.handlers=[];for(r=0;r<s.length;r++){var q=s[r];try{if(q.isMatch(u)&&(m.authenticated||!q.user)){if(q.run(u)){m.handlers.push(q);}}else{m.handlers.push(q);}}catch(t){e.warn("Removing Strophe handlers due to uncaught exception: "+t.message);}}});},mechanisms:{},_connect_cb:function(o,r,p){e.info("_connect_cb was called");this.connected=true;var h=this._proto._reqToData(o);if(!h){return;}if(this.xmlInput!==e.Connection.prototype.xmlInput){if(h.nodeName===this._proto.strip&&h.childNodes.length){this.xmlInput(h.childNodes[0]);}else{this.xmlInput(h);}}if(this.rawInput!==e.Connection.prototype.rawInput){if(p){this.rawInput(p);}else{this.rawInput(e.serialize(h));}}var j=this._proto._connect_cb(h);if(j===e.Status.CONNFAIL){return;}this._authentication.sasl_scram_sha1=false;this._authentication.sasl_plain=false;this._authentication.sasl_digest_md5=false;this._authentication.sasl_anonymous=false;this._authentication.legacy_auth=false;var l=h.getElementsByTagName("stream:features").length>0;if(!l){l=h.getElementsByTagName("features").length>0;}var q=h.getElementsByTagName("mechanism");var g=[];var k,m,n=false;if(!l){this._proto._no_auth_received(r);return;}if(q.length>0){for(k=0;k<q.length;k++){m=e.getText(q[k]);if(this.mechanisms[m]){g.push(this.mechanisms[m]);}}}this._authentication.legacy_auth=h.getElementsByTagName("auth").length>0;n=this._authentication.legacy_auth||g.length>0;if(!n){this._proto._no_auth_received(r);return;}if(this.do_authentication!==false){this.authenticate(g);}},authenticate:function(h){var m;for(m=0;m<h.length-1;++m){var g=m;for(var l=m+1;l<h.length;++l){if(h[l].prototype.priority>h[g].prototype.priority){g=l;}}if(g!=m){var o=h[m];h[m]=h[g];h[g]=o;}}var n=false;for(m=0;m<h.length;++m){if(!h[m].test(this)){continue;}this._sasl_success_handler=this._addSysHandler(this._sasl_success_cb.bind(this),null,"success",null,null);this._sasl_failure_handler=this._addSysHandler(this._sasl_failure_cb.bind(this),null,"failure",null,null);this._sasl_challenge_handler=this._addSysHandler(this._sasl_challenge_cb.bind(this),null,"challenge",null,null);this._sasl_mechanism=new h[m]();this._sasl_mechanism.onStart(this);var p=c("auth",{xmlns:e.NS.SASL,mechanism:this._sasl_mechanism.name});if(this._sasl_mechanism.isClientFirst){var k=this._sasl_mechanism.onChallenge(this,null);p.t(Base64.encode(k));}this.send(p.tree());n=true;break;}if(!n){if(e.getNodeFromJid(this.jid)===null){this._changeConnectStatus(e.Status.CONNFAIL,"x-strophe-bad-non-anon-jid");this.disconnect("x-strophe-bad-non-anon-jid");}else{this._changeConnectStatus(e.Status.AUTHENTICATING,null);this._addSysHandler(this._auth1_cb.bind(this),null,null,null,"_auth_1");this.send(d({type:"get",to:this.domain,id:"_auth_1"}).c("query",{xmlns:e.NS.AUTH}).c("username",{}).t(e.getNodeFromJid(this.jid)).tree());}}},_sasl_challenge_cb:function(i){var h=Base64.decode(e.getText(i));var g=this._sasl_mechanism.onChallenge(this,h);var j=c("response",{xmlns:e.NS.SASL});if(g!==""){j.t(Base64.encode(g));}this.send(j.tree());return true;},_auth1_cb:function(g){var h=d({type:"set",id:"_auth_2"}).c("query",{xmlns:e.NS.AUTH}).c("username",{}).t(e.getNodeFromJid(this.jid)).up().c("password").t(this.pass);if(!e.getResourceFromJid(this.jid)){this.jid=e.getBareJidFromJid(this.jid)+"/strophe";}h.up().c("resource",{}).t(e.getResourceFromJid(this.jid));this._addSysHandler(this._auth2_cb.bind(this),null,null,null,"_auth_2");this.send(h.tree());return false;},_sasl_success_cb:function(h){if(this._sasl_data["server-signature"]){var g;var k=Base64.decode(e.getText(h));var j=/([a-z]+)=([^,]+)(,|$)/;var i=k.match(j);if(i[1]=="v"){g=i[2];}if(g!=this._sasl_data["server-signature"]){this.deleteHandler(this._sasl_failure_handler);this._sasl_failure_handler=null;if(this._sasl_challenge_handler){this.deleteHandler(this._sasl_challenge_handler);this._sasl_challenge_handler=null;}this._sasl_data={};return this._sasl_failure_cb(null);}}e.info("SASL authentication succeeded.");if(this._sasl_mechanism){this._sasl_mechanism.onSuccess();}this.deleteHandler(this._sasl_failure_handler);this._sasl_failure_handler=null;if(this._sasl_challenge_handler){this.deleteHandler(this._sasl_challenge_handler);this._sasl_challenge_handler=null;}this._addSysHandler(this._sasl_auth1_cb.bind(this),null,"stream:features",null,null);this._sendRestart();return false;},_sasl_auth1_cb:function(h){this.features=h;var g,k;for(g=0;g<h.childNodes.length;g++){k=h.childNodes[g];if(k.nodeName=="bind"){this.do_bind=true;}if(k.nodeName=="session"){this.do_session=true;}}if(!this.do_bind){this._changeConnectStatus(e.Status.AUTHFAIL,null);return false;}else{this._addSysHandler(this._sasl_bind_cb.bind(this),null,null,null,"_bind_auth_2");var j=e.getResourceFromJid(this.jid);if(j){this.send(d({type:"set",id:"_bind_auth_2"}).c("bind",{xmlns:e.NS.BIND}).c("resource",{}).t(j).tree());}else{this.send(d({type:"set",id:"_bind_auth_2"}).c("bind",{xmlns:e.NS.BIND}).tree());}}return false;},_sasl_bind_cb:function(g){if(g.getAttribute("type")=="error"){e.info("SASL binding failed.");var h=g.getElementsByTagName("conflict"),k;if(h.length>0){k="conflict";}this._changeConnectStatus(e.Status.AUTHFAIL,k);return false;}var j=g.getElementsByTagName("bind");var i;if(j.length>0){i=j[0].getElementsByTagName("jid");if(i.length>0){this.jid=e.getText(i[0]);if(this.do_session){this._addSysHandler(this._sasl_session_cb.bind(this),null,null,null,"_session_auth_2");this.send(d({type:"set",id:"_session_auth_2"}).c("session",{xmlns:e.NS.SESSION}).tree());}else{this.authenticated=true;this._changeConnectStatus(e.Status.CONNECTED,null);}}}else{e.info("SASL binding failed.");this._changeConnectStatus(e.Status.AUTHFAIL,null);return false;}},_sasl_session_cb:function(g){if(g.getAttribute("type")=="result"){this.authenticated=true;this._changeConnectStatus(e.Status.CONNECTED,null);}else{if(g.getAttribute("type")=="error"){e.info("Session creation failed.");this._changeConnectStatus(e.Status.AUTHFAIL,null);return false;}}return false;},_sasl_failure_cb:function(g){if(this._sasl_success_handler){this.deleteHandler(this._sasl_success_handler);this._sasl_success_handler=null;}if(this._sasl_challenge_handler){this.deleteHandler(this._sasl_challenge_handler);this._sasl_challenge_handler=null;}if(this._sasl_mechanism){this._sasl_mechanism.onFailure();}this._changeConnectStatus(e.Status.AUTHFAIL,null);return false;},_auth2_cb:function(g){if(g.getAttribute("type")=="result"){this.authenticated=true;this._changeConnectStatus(e.Status.CONNECTED,null);}else{if(g.getAttribute("type")=="error"){this._changeConnectStatus(e.Status.AUTHFAIL,null);this.disconnect("authentication failed");}}return false;},_addSysTimedHandler:function(i,h){var g=new e.TimedHandler(i,h);g.user=false;this.addTimeds.push(g);return g;},_addSysHandler:function(k,j,h,i,l){var g=new e.Handler(k,j,h,i,l);g.user=false;this.addHandlers.push(g);return g;},_onDisconnectTimeout:function(){e.info("_onDisconnectTimeout was called");this._proto._onDisconnectTimeout();this._doDisconnect();return false;},_onIdle:function(){var h,k,l,j;while(this.addTimeds.length>0){this.timedHandlers.push(this.addTimeds.pop());}while(this.removeTimeds.length>0){k=this.removeTimeds.pop();h=this.timedHandlers.indexOf(k);if(h>=0){this.timedHandlers.splice(h,1);}}var g=new Date().getTime();j=[];for(h=0;h<this.timedHandlers.length;h++){k=this.timedHandlers[h];if(this.authenticated||!k.user){l=k.lastCalled+k.period;if(l-g<=0){if(k.run()){j.push(k);}}else{j.push(k);}}}this.timedHandlers=j;clearTimeout(this._idleTimeout);this._proto._onIdle();if(this.connected){this._idleTimeout=setTimeout(this._onIdle.bind(this),100);}}};if(f){f(e,c,a,d,b);}e.SASLMechanism=function(g,i,h){this.name=g;this.isClientFirst=i;this.priority=h;};e.SASLMechanism.prototype={test:function(g){return true;},onStart:function(g){this._connection=g;},onChallenge:function(g,h){throw new Error("You should implement challenge handling!");},onFailure:function(){this._connection=null;},onSuccess:function(){this._connection=null;}};e.SASLAnonymous=function(){};e.SASLAnonymous.prototype=new e.SASLMechanism("ANONYMOUS",false,10);e.SASLAnonymous.test=function(g){return g.authcid===null;};e.Connection.prototype.mechanisms[e.SASLAnonymous.prototype.name]=e.SASLAnonymous;e.SASLPlain=function(){};e.SASLPlain.prototype=new e.SASLMechanism("PLAIN",true,20);e.SASLPlain.test=function(g){return g.authcid!==null;};e.SASLPlain.prototype.onChallenge=function(h){var g=h.authzid;g=g+"\u0000";g=g+h.authcid;g=g+"\u0000";g=g+h.pass;return g;};e.Connection.prototype.mechanisms[e.SASLPlain.prototype.name]=e.SASLPlain;e.SASLSHA1=function(){};e.SASLSHA1.prototype=new e.SASLMechanism("SCRAM-SHA-1",true,40);e.SASLSHA1.test=function(g){return g.authcid!==null;};e.SASLSHA1.prototype.onChallenge=function(h,i,j){var k=j||MD5.hexdigest(Math.random()*1234567890);var g="n="+h.authcid;g+=",r=";g+=k;h._sasl_data.cnonce=k;h._sasl_data["client-first-message-bare"]=g;g="n,,"+g;this.onChallenge=function(t,C){var A,n,x,q,o,v,y,w;var l,u,z;var s="c=biws,";var r=t._sasl_data["client-first-message-bare"]+","+C+",";var B=t._sasl_data.cnonce;var p=/([a-z]+)=([^,]+)(,|$)/;while(C.match(p)){var m=C.match(p);C=C.replace(m[0],"");switch(m[1]){case"r":A=m[2];break;case"s":n=m[2];break;case"i":x=m[2];break;}}if(A.substr(0,B.length)!==B){t._sasl_data={};return t._sasl_failure_cb();}s+="r="+A;r+=s;n=Base64.decode(n);n+="\x00\x00\x00\x01";q=v=core_hmac_sha1(t.pass,n);for(y=1;y<x;y++){o=core_hmac_sha1(t.pass,binb2str(v));for(w=0;w<5;w++){q[w]^=o[w];}v=o;}q=binb2str(q);l=core_hmac_sha1(q,"Client Key");u=str_hmac_sha1(q,"Server Key");z=core_hmac_sha1(str_sha1(binb2str(l)),r);t._sasl_data["server-signature"]=b64_hmac_sha1(u,r);for(w=0;w<5;w++){l[w]^=z[w];}s+=",p="+Base64.encode(binb2str(l));return s;}.bind(this);return g;};e.Connection.prototype.mechanisms[e.SASLSHA1.prototype.name]=e.SASLSHA1;e.SASLMD5=function(){};e.SASLMD5.prototype=new e.SASLMechanism("DIGEST-MD5",false,30);e.SASLMD5.test=function(g){return g.authcid!==null;};e.SASLMD5.prototype._quote=function(g){return'"'+g.replace(/\\/g,"\\\\").replace(/"/g,'\\"')+'"';};e.SASLMD5.prototype.onChallenge=function(h,r,n){var i=/([a-z]+)=("[^"]+"|[^,"]+)(?:,|$)/;var s=n||MD5.hexdigest(""+(Math.random()*1234567890));var o="";var t=null;var p="";var g="";var m;while(r.match(i)){m=r.match(i);r=r.replace(m[0],"");m[2]=m[2].replace(/^"(.+)"$/,"$1");switch(m[1]){case"realm":o=m[2];break;case"nonce":p=m[2];break;case"qop":g=m[2];break;case"host":t=m[2];break;}}var l=h.servtype+"/"+h.domain;if(t!==null){l=l+"/"+t;}var k=MD5.hash(h.authcid+":"+o+":"+this._connection.pass)+":"+p+":"+s;var j="AUTHENTICATE:"+l;var q="";q+="charset=utf-8,";q+="username="+this._quote(h.authcid)+",";q+="realm="+this._quote(o)+",";q+="nonce="+this._quote(p)+",";q+="nc=00000001,";q+="cnonce="+this._quote(s)+",";q+="digest-uri="+this._quote(l)+",";q+="response="+MD5.hexdigest(MD5.hexdigest(k)+":"+p+":00000001:"+s+":auth:"+MD5.hexdigest(j))+",";q+="qop=auth";this.onChallenge=function(){return"";}.bind(this);return q;};e.Connection.prototype.mechanisms[e.SASLMD5.prototype.name]=e.SASLMD5;})(function(){window.Strophe=arguments[0];window.$build=arguments[1];window.$msg=arguments[2];window.$iq=arguments[3];window.$pres=arguments[4];});Strophe.Request=function(c,b,a,d){this.id=++Strophe._requestId;this.xmlData=c;this.data=Strophe.serialize(c);this.origFunc=b;this.func=b;this.rid=a;this.date=NaN;this.sends=d||0;this.abort=false;this.dead=null;this.age=function(){if(!this.date){return 0;}var e=new Date();return(e-this.date)/1000;};this.timeDead=function(){if(!this.dead){return 0;}var e=new Date();return(e-this.dead)/1000;};this.xhr=this._newXHR();};Strophe.Request.prototype={getResponse:function(){var a=null;if(this.xhr.responseXML&&this.xhr.responseXML.documentElement){a=this.xhr.responseXML.documentElement;if(a.tagName=="parsererror"){Strophe.error("invalid response received");Strophe.error("responseText: "+this.xhr.responseText);Strophe.error("responseXML: "+Strophe.serialize(this.xhr.responseXML));throw"parsererror";}}else{if(this.xhr.responseText){Strophe.error("invalid response received");Strophe.error("responseText: "+this.xhr.responseText);Strophe.error("responseXML: "+Strophe.serialize(this.xhr.responseXML));}}return a;},_newXHR:function(){var a=null;if(window.XMLHttpRequest){a=new XMLHttpRequest();if(a.overrideMimeType){a.overrideMimeType("text/xml");}}else{if(window.ActiveXObject){a=new ActiveXObject("Microsoft.XMLHTTP");}}a.onreadystatechange=this.func.bind(null,this);return a;}};Strophe.Bosh=function(a){this._conn=a;this.rid=Math.floor(Math.random()*4294967295);this.sid=null;this.hold=1;this.wait=60;this.window=5;this._requests=[];};Strophe.Bosh.prototype={strip:null,_buildBody:function(){var a=$build("body",{rid:this.rid++,xmlns:Strophe.NS.HTTPBIND});if(this.sid!==null){a.attrs({sid:this.sid});}return a;},_reset:function(){this.rid=Math.floor(Math.random()*4294967295);this.sid=null;},_connect:function(e,d,b){this.wait=e||this.wait;this.hold=d||this.hold;var a=this._buildBody().attrs({to:this._conn.domain,"xml:lang":"en",wait:this.wait,hold:this.hold,content:"text/xml; charset=utf-8",ver:"1.6","xmpp:version":"1.0","xmlns:xmpp":Strophe.NS.BOSH});if(b){a.attrs({route:b});}var c=this._conn._connect_cb;this._requests.push(new Strophe.Request(a.tree(),this._onRequestStateChange.bind(this,c.bind(this._conn)),a.tree().getAttribute("rid")));this._throttledRequestHandler();},_attach:function(c,a,d,g,f,e,b){this._conn.jid=c;this.sid=a;this.rid=d;this._conn.connect_callback=g;this._conn.domain=Strophe.getDomainFromJid(this._conn.jid);this._conn.authenticated=true;this._conn.connected=true;this.wait=f||this.wait;this.hold=e||this.hold;this.window=b||this.window;this._conn._changeConnectStatus(Strophe.Status.ATTACHED,null);},_connect_cb:function(b){var d=b.getAttribute("type");var c,e;if(d!==null&&d=="terminate"){Strophe.error("BOSH-Connection failed: "+c);c=b.getAttribute("condition");e=b.getElementsByTagName("conflict");if(c!==null){if(c=="remote-stream-error"&&e.length>0){c="conflict";}this._conn._changeConnectStatus(Strophe.Status.CONNFAIL,c);}else{this._conn._changeConnectStatus(Strophe.Status.CONNFAIL,"unknown");}this._conn._doDisconnect();return Strophe.Status.CONNFAIL;}if(!this.sid){this.sid=b.getAttribute("sid");}var a=b.getAttribute("requests");if(a){this.window=parseInt(a,10);}var g=b.getAttribute("hold");if(g){this.hold=parseInt(g,10);}var f=b.getAttribute("wait");if(f){this.wait=parseInt(f,10);}},_disconnect:function(a){this._sendTerminate(a);},_doDisconnect:function(){this.sid=null;this.rid=Math.floor(Math.random()*4294967295);},_emptyQueue:function(){return this._requests.length===0;},_hitError:function(a){this.errors++;Strophe.warn("request errored, status: "+a+", number of errors: "+this.errors);if(this.errors>4){this._onDisconnectTimeout();}},_no_auth_received:function(b){if(b){b=b.bind(this._conn);}else{b=this._conn._connect_cb.bind(this._conn);}var a=this._buildBody();this._requests.push(new Strophe.Request(a.tree(),this._onRequestStateChange.bind(this,b.bind(this._conn)),a.tree().getAttribute("rid")));this._throttledRequestHandler();},_onDisconnectTimeout:function(){var a;while(this._requests.length>0){a=this._requests.pop();a.abort=true;a.xhr.abort();a.xhr.onreadystatechange=function(){};}},_onIdle:function(){var c=this._conn._data;if(this._conn.authenticated&&this._requests.length===0&&c.length===0&&!this._conn.disconnecting){Strophe.info("no requests during idle cycle, sending blank request");c.push(null);}if(this._requests.length<2&&c.length>0&&!this._conn.paused){var a=this._buildBody();for(var b=0;b<c.length;b++){if(c[b]!==null){if(c[b]==="restart"){a.attrs({to:this._conn.domain,"xml:lang":"en","xmpp:restart":"true","xmlns:xmpp":Strophe.NS.BOSH});}else{a.cnode(c[b]).up();}}}delete this._conn._data;this._conn._data=[];this._requests.push(new Strophe.Request(a.tree(),this._onRequestStateChange.bind(this,this._conn._dataRecv.bind(this._conn)),a.tree().getAttribute("rid")));this._processRequest(this._requests.length-1);}if(this._requests.length>0){var d=this._requests[0].age();if(this._requests[0].dead!==null){if(this._requests[0].timeDead()>Math.floor(Strophe.SECONDARY_TIMEOUT*this.wait)){this._throttledRequestHandler();}}if(d>Math.floor(Strophe.TIMEOUT*this.wait)){Strophe.warn("Request "+this._requests[0].id+" timed out, over "+Math.floor(Strophe.TIMEOUT*this.wait)+" seconds since last activity");this._throttledRequestHandler();}}},_onRequestStateChange:function(d,c){Strophe.debug("request id "+c.id+"."+c.sends+" state changed to "+c.xhr.readyState);if(c.abort){c.abort=false;return;}var b;if(c.xhr.readyState==4){b=0;try{b=c.xhr.status;}catch(f){}if(typeof(b)=="undefined"){b=0;}if(this.disconnecting){if(b>=400){this._hitError(b);return;}}var a=(this._requests[0]==c);var g=(this._requests[1]==c);if((b>0&&b<500)||c.sends>5){this._removeRequest(c);Strophe.debug("request id "+c.id+" should now be removed");}if(b==200){if(g||(a&&this._requests.length>0&&this._requests[0].age()>Math.floor(Strophe.SECONDARY_TIMEOUT*this.wait))){this._restartRequest(0);}Strophe.debug("request id "+c.id+"."+c.sends+" got 200");d(c);this.errors=0;}else{Strophe.error("request id "+c.id+"."+c.sends+" error "+b+" happened");if(b===0||(b>=400&&b<600)||b>=12000){this._hitError(b);if(b>=400&&b<500){this._conn._changeConnectStatus(Strophe.Status.DISCONNECTING,null);this._conn._doDisconnect();}}}if(!((b>0&&b<500)||c.sends>5)){this._throttledRequestHandler();}}},_processRequest:function(c){var n=this;var j=this._requests[c];var m=-1;try{if(j.xhr.readyState==4){m=j.xhr.status;}}catch(g){Strophe.error("caught an error in _requests["+c+"], reqStatus: "+m);}if(typeof(m)=="undefined"){m=-1;}if(j.sends>this.maxRetries){this._onDisconnectTimeout();return;}var b=j.age();var a=(!isNaN(b)&&b>Math.floor(Strophe.TIMEOUT*this.wait));var d=(j.dead!==null&&j.timeDead()>Math.floor(Strophe.SECONDARY_TIMEOUT*this.wait));var l=(j.xhr.readyState==4&&(m<1||m>=500));if(a||d||l){if(d){Strophe.error("Request "+this._requests[c].id+" timed out (secondary), restarting");}j.abort=true;j.xhr.abort();j.xhr.onreadystatechange=function(){};this._requests[c]=new Strophe.Request(j.xmlData,j.origFunc,j.rid,j.sends);j=this._requests[c];}if(j.xhr.readyState===0){Strophe.debug("request id "+j.id+"."+j.sends+" posting");try{j.xhr.open("POST",this._conn.service,this._conn.options.sync?false:true);}catch(h){Strophe.error("XHR open failed.");if(!this._conn.connected){this._conn._changeConnectStatus(Strophe.Status.CONNFAIL,"bad-service");}this._conn.disconnect();return;}var k=function(){j.date=new Date();if(n._conn.options.customHeaders){var e=n._conn.options.customHeaders;for(var i in e){if(e.hasOwnProperty(i)){j.xhr.setRequestHeader(i,e[i]);}}}j.xhr.send(j.data);};if(j.sends>1){var f=Math.min(Math.floor(Strophe.TIMEOUT*this.wait),Math.pow(j.sends,3))*1000;setTimeout(k,f);}else{k();}j.sends++;if(this._conn.xmlOutput!==Strophe.Connection.prototype.xmlOutput){if(j.xmlData.nodeName===this.strip&&j.xmlData.childNodes.length){this._conn.xmlOutput(j.xmlData.childNodes[0]);}else{this._conn.xmlOutput(j.xmlData);}}if(this._conn.rawOutput!==Strophe.Connection.prototype.rawOutput){this._conn.rawOutput(j.data);}}else{Strophe.debug("_processRequest: "+(c===0?"first":"second")+" request has readyState of "+j.xhr.readyState);}},_removeRequest:function(b){Strophe.debug("removing request");var a;for(a=this._requests.length-1;a>=0;a--){if(b==this._requests[a]){this._requests.splice(a,1);}}b.xhr.onreadystatechange=function(){};this._throttledRequestHandler();},_restartRequest:function(a){var b=this._requests[a];if(b.dead===null){b.dead=new Date();}this._processRequest(a);},_reqToData:function(a){try{return a.getResponse();}catch(b){if(b!="parsererror"){throw b;}this._conn.disconnect("strophe-parsererror");}},_sendTerminate:function(c){Strophe.info("_sendTerminate was called");var a=this._buildBody().attrs({type:"terminate"});if(c){a.cnode(c.tree());}var b=new Strophe.Request(a.tree(),this._onRequestStateChange.bind(this,this._conn._dataRecv.bind(this._conn)),a.tree().getAttribute("rid"));this._requests.push(b);this._throttledRequestHandler();},_send:function(){clearTimeout(this._conn._idleTimeout);this._throttledRequestHandler();this._conn._idleTimeout=setTimeout(this._conn._onIdle.bind(this._conn),100);},_sendRestart:function(){this._throttledRequestHandler();clearTimeout(this._conn._idleTimeout);},_throttledRequestHandler:function(){if(!this._requests){Strophe.debug("_throttledRequestHandler called with undefined requests");}else{Strophe.debug("_throttledRequestHandler called with "+this._requests.length+" requests");}if(!this._requests||this._requests.length===0){return;}if(this._requests.length>0){this._processRequest(0);}if(this._requests.length>1&&Math.abs(this._requests[0].rid-this._requests[1].rid)<this.window){this._processRequest(1);}}};Strophe.Websocket=function(c){this._conn=c;this.strip="stream:stream";var a=c.service;if(a.indexOf("ws:")!==0&&a.indexOf("wss:")!==0){var b="";if(c.options.protocol==="ws"&&window.location.protocol!=="https:"){b+="ws";}else{b+="wss";}b+="://"+window.location.host;if(a.indexOf("/")!==0){b+=window.location.pathname+a;}else{b+=a;}c.service=b;}};Strophe.Websocket.prototype={_buildStream:function(){return $build("stream:stream",{to:this._conn.domain,xmlns:Strophe.NS.CLIENT,"xmlns:stream":Strophe.NS.STREAM,version:"1.0"});},_check_streamerror:function(a,g){var k=a.getElementsByTagName("stream:error");if(k.length===0){return false;}var h=k[0];var b="";var l="";var j="urn:ietf:params:xml:ns:xmpp-streams";for(var d=0;d<h.childNodes.length;d++){var f=h.childNodes[d];if(f.getAttribute("xmlns")!==j){break;}if(f.nodeName==="text"){l=f.textContent;}else{b=f.nodeName;}}var c="WebSocket stream error: ";if(b){c+=b;}else{c+="unknown";}if(l){c+=" - "+b;}Strophe.error(c);this._conn._changeConnectStatus(g,b);this._conn._doDisconnect();return true;},_reset:function(){return;},_connect:function(){this._closeSocket();this.socket=new WebSocket(this._conn.service,"xmpp");this.socket.onopen=this._onOpen.bind(this);this.socket.onerror=this._onError.bind(this);this.socket.onclose=this._onClose.bind(this);this.socket.onmessage=this._connect_cb_wrapper.bind(this);},_connect_cb:function(b){var a=this._check_streamerror(b,Strophe.Status.CONNFAIL);if(a){return Strophe.Status.CONNFAIL;}},_handleStreamStart:function(e){var b=false;var d=e.getAttribute("xmlns");if(typeof d!=="string"){b="Missing xmlns in stream:stream";}else{if(d!==Strophe.NS.CLIENT){b="Wrong xmlns in stream:stream: "+d;}}var c=e.namespaceURI;if(typeof c!=="string"){b="Missing xmlns:stream in stream:stream";}else{if(c!==Strophe.NS.STREAM){b="Wrong xmlns:stream in stream:stream: "+c;}}var a=e.getAttribute("version");if(typeof a!=="string"){b="Missing version in stream:stream";}else{if(a!=="1.0"){b="Wrong version in stream:stream: "+a;}}if(b){this._conn._changeConnectStatus(Strophe.Status.CONNFAIL,b);this._conn._doDisconnect();return false;}return true;},_connect_cb_wrapper:function(d){if(d.data.indexOf("<stream:stream ")===0||d.data.indexOf("<?xml")===0){var e=d.data.replace(/^(<\?.*?\?>\s*)*/,"");if(e===""){return;}e=d.data.replace(/<stream:stream (.*[^\/])>/,"<stream:stream $1/>");var b=new DOMParser().parseFromString(e,"text/xml").documentElement;this._conn.xmlInput(b);this._conn.rawInput(d.data);if(this._handleStreamStart(b)){this._connect_cb(b);this.streamStart=d.data.replace(/^<stream:(.*)\/>$/,"<stream:$1>");}}else{if(d.data==="</stream:stream>"){this._conn.rawInput(d.data);this._conn.xmlInput(document.createElement("stream:stream"));this._conn._changeConnectStatus(Strophe.Status.CONNFAIL,"Received closing stream");this._conn._doDisconnect();return;}else{var a=this._streamWrap(d.data);var c=new DOMParser().parseFromString(a,"text/xml").documentElement;this.socket.onmessage=this._onMessage.bind(this);this._conn._connect_cb(c,null,d.data);}}},_disconnect:function(c){if(this.socket.readyState!==WebSocket.CLOSED){if(c){this._conn.send(c);}var b="</stream:stream>";this._conn.xmlOutput(document.createElement("stream:stream"));this._conn.rawOutput(b);try{this.socket.send(b);}catch(a){Strophe.info("Couldn't send closing stream tag.");}}this._conn._doDisconnect();},_doDisconnect:function(){Strophe.info("WebSockets _doDisconnect was called");this._closeSocket();},_streamWrap:function(a){return this.streamStart+a+"</stream:stream>";},_closeSocket:function(){if(this.socket){try{this.socket.close();}catch(a){}}this.socket=null;},_emptyQueue:function(){return true;},_onClose:function(){if(this._conn.connected&&!this._conn.disconnecting){Strophe.error("Websocket closed unexcectedly");this._conn._doDisconnect();}else{Strophe.info("Websocket closed");}},_no_auth_received:function(a){Strophe.error("Server did not send any auth methods");this._conn._changeConnectStatus(Strophe.Status.CONNFAIL,"Server did not send any auth methods");if(a){a=a.bind(this._conn);a();}this._conn._doDisconnect();},_onDisconnectTimeout:function(){},_onError:function(a){Strophe.error("Websocket error "+a);this._conn._changeConnectStatus(Strophe.Status.CONNFAIL,"The WebSocket connection could not be established was disconnected.");this._disconnect();},_onIdle:function(){var b=this._conn._data;if(b.length>0&&!this._conn.paused){for(var a=0;a<b.length;a++){if(b[a]!==null){var c,d;if(b[a]==="restart"){c=this._buildStream();d=this._removeClosingTag(c);c=c.tree();}else{c=b[a];d=Strophe.serialize(c);}this._conn.xmlOutput(c);this._conn.rawOutput(d);this.socket.send(d);}}this._conn._data=[];}},_onMessage:function(b){var a,c;if(b.data==="</stream:stream>"){var d="</stream:stream>";this._conn.rawInput(d);this._conn.xmlInput(document.createElement("stream:stream"));if(!this._conn.disconnecting){this._conn._doDisconnect();}return;}else{if(b.data.search("<stream:stream ")===0){c=b.data.replace(/<stream:stream (.*[^\/])>/,"<stream:stream $1/>");a=new DOMParser().parseFromString(c,"text/xml").documentElement;if(!this._handleStreamStart(a)){return;}}else{c=this._streamWrap(b.data);a=new DOMParser().parseFromString(c,"text/xml").documentElement;}}if(this._check_streamerror(a,Strophe.Status.ERROR)){return;}if(this._conn.disconnecting&&a.firstChild.nodeName==="presence"&&a.firstChild.getAttribute("type")==="unavailable"){this._conn.xmlInput(a);this._conn.rawInput(Strophe.serialize(a));return;}this._conn._dataRecv(a,b.data);},_onOpen:function(){Strophe.info("Websocket open");var b=this._buildStream();this._conn.xmlOutput(b.tree());var a=this._removeClosingTag(b);this._conn.rawOutput(a);this.socket.send(a);},_removeClosingTag:function(b){var a=Strophe.serialize(b);a=a.replace(/<(stream:stream .*[^\/])\/>$/,"<$1>");return a;},_reqToData:function(a){return a;},_send:function(){this._conn.flush();},_sendRestart:function(){clearTimeout(this._conn._idleTimeout);this._conn._onIdle.bind(this._conn)();}};